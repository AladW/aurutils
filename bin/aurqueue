#!/bin/bash
# shellcheck disable=SC2016
readonly argv0=aurqueue
readonly PS4='+(${BASH_SOURCE}:${LINENO}): ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
set -o pipefail

deps() {
    awk -v FS='[<=>]' '
    /pkgbase/ {
        read = 1; pb = $2

        printf("%s\t%s\n", pb, pb)
    } {
        if (read && $0 ~ /^\t(make|check)?depends/) {
            printf("%s\t%s\n", pb, $2)
        }

        if ($0 ~ /^$/) {
            read = 0    # split package
        }
    }' "$@"
}

base() {
    awk -v FS='[<=>]' '
    /pkgbase/ {
        pb = $2
    }

    /pkgname/ {
        printf("%s\t%s\n", $2, pb)
    }' "$@"
}

sub() {
    awk 'NR == FNR {
        x[$1] = $2; next
    } {
        if ($1 in x && !(x[$1] in seen)) {
            print x[$1]; seen[x[$1]];
        }
    }' "$@"
}

trap_exit() {
    if [[ ! -o xtrace ]]; then
        rm -rf "$tmp"
    fi
    unset arg_path arg_raw_path arg_stdin_path
}

usage() {
    plain "usage: $argv0 pkgname..."
    exit 1
}

readonly -f deps base sub trap_exit usage
# shellcheck disable=SC1091
source /usr/share/makepkg/util.sh || exit

if [[ -t 2 ]]; then
    colorize
fi

while getopts h OPT; do
    case $OPT in
        *|h) usage ;;
    esac
done

shift "$((OPTIND - 1))"
OPTIND=1

if ( ((!$#)) && [[ -t 0 ]] ); then
    usage
fi

tmp=$(mktemp -t "$argv0".XXXXXXXX) || exit
declare -a arg_path arg_raw_path arg_stdin_path
trap 'trap_exit' EXIT

# If part of a pipe read from standard input
if [[ ! -t 0 ]]; then
    mapfile -t arg_raw_path </dev/stdin
    mapfile -t arg_stdin_path < <(readlink -e -- "${arg_raw_path[@]}")
else
    # If the paths given contain - allow user to
    # specify paths manually on the command line
    for i in "$@"; do case "$i" in
    -)
        mapfile -t arg_raw_path </dev/stdin
        mapfile -t arg_stdin_path < <(readlink -e -- "${arg_raw_path[@]}") ;;
    esac; done
fi

if (($#)); then
    mapfile -t arg_path < <(readlink -e -- "$@")
fi

arg_path+=("${arg_stdin_path[@]}")

find "${arg_path[@]}" -maxdepth 1 -type f -name .SRCINFO -print0 | xargs -r0 cat > "$tmp"

if [[ -s "$tmp" ]]; then
    tsort <(deps "$tmp") | sub <(base "$tmp") - | grep -Fxf <(printf -- '%s\n' "${@##*/}") | tac
fi

# vim: set et sw=4 sts=4 ft=sh:
